version: "3"

tasks:
  # ====================
  # リンク管理
  # ====================
  # NOTE: stow を直接実行しないこと。-t ~ を付けないと親ディレクトリにリンクが作られる。
  # 必ず task link-* / task unlink-* を使用する。
  link:
    desc: 初回セットアップ時に全パッケージをホーム配下へリンク
    cmds:
      - task: link-shell
      - task: link-config
      - task: link-claude
      - task: link-codex
      - task: link-gemini
      - task: link-tmux
      - task: link-alfred

  link-shell:
    desc: シェル設定を反映したいときに .zshrc/.zprofile をリンク
    cmds:
      - stow {{.STOW_FLAGS}} shell

  link-config:
    desc: .config 配下の設定を反映したいときにリンク (wezterm, starship, mise, sheldon)
    cmds:
      - stow {{.STOW_FLAGS}} config

  link-claude:
    desc: Claude 設定を反映したいときに ~/.claude をリンク
    cmds:
      - stow {{.STOW_FLAGS}} claude

  link-codex:
    desc: Codex 設定を反映したいときに ~/.codex をリンク
    cmds:
      - stow {{.STOW_FLAGS}} codex

  link-gemini:
    desc: Gemini 設定を反映したいときに ~/.gemini をリンク
    cmds:
      - stow {{.STOW_FLAGS}} gemini

  link-tmux:
    desc: tmux 設定を反映したいときに .tmux.conf をリンク
    cmds:
      - stow {{.STOW_FLAGS}} tmux

  link-alfred:
    desc: Alfred ワークフローを初回導入/再接続したいときにリンク
    cmds:
      - |
        src="{{.ROOT_DIR}}/alfred/Open-VS-or-IT"
        dest="$HOME/Dropbox/02_Private/08_Settings/02_Alfred/Alfred.alfredpreferences/workflows/user.workflow.C9692AD7-2800-42B7-8F97-8F8CCD1CC88E"
        if [[ -L "$dest" ]]; then
          echo "Already linked: $dest"
        elif [[ -e "$dest" ]]; then
          echo "Warning: $dest exists and is not a symlink. Skipping."
        else
          ln -snf "$src" "$dest"
          echo "Linked: $dest -> $src"
        fi

  # ====================
  # リンク解除
  # ====================
  unlink:
    desc: dotfiles 管理を一時解除したいときに全リンクを削除
    cmds:
      - task: unlink-shell
      - task: unlink-config
      - task: unlink-claude
      - task: unlink-codex
      - task: unlink-gemini
      - task: unlink-tmux
      - task: unlink-alfred

  unlink-shell:
    desc: シェル設定リンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} shell

  unlink-config:
    desc: .config 配下のリンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} config

  unlink-claude:
    desc: Claude 設定リンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} claude

  unlink-codex:
    desc: Codex 設定リンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} codex

  unlink-gemini:
    desc: Gemini 設定リンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} gemini

  unlink-tmux:
    desc: tmux 設定リンクのみ外したいときに解除
    cmds:
      - stow -D {{.STOW_FLAGS}} tmux

  unlink-alfred:
    desc: Alfred ワークフローリンクのみ外したいときに解除
    cmds:
      - |
        dest="$HOME/Dropbox/02_Private/08_Settings/02_Alfred/Alfred.alfredpreferences/workflows/user.workflow.C9692AD7-2800-42B7-8F97-8F8CCD1CC88E"
        if [[ -L "$dest" ]]; then
          rm "$dest"
          echo "Unlinked: $dest"
        else
          echo "Not a symlink or not found: $dest"
        fi

  # ====================
  # 再リンク (restow)
  # ====================
  restow:
    desc: 設定変更後に全パッケージを最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} shell config claude codex gemini tmux
      - task: unlink-alfred
      - task: link-alfred

  restow-shell:
    desc: シェル設定だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} shell

  restow-config:
    desc: .config 配下だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} config

  restow-claude:
    desc: Claude 設定だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} claude

  restow-codex:
    desc: Codex 設定だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} codex

  restow-gemini:
    desc: Gemini 設定だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} gemini

  restow-tmux:
    desc: tmux 設定だけ最新化したいときに再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} tmux

  restow-alfred:
    desc: Alfred ワークフローだけ最新化したいときに再リンク
    cmds:
      - task: unlink-alfred
      - task: link-alfred
