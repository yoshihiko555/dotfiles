version: "3"

tasks:
  # ====================
  # リンク管理
  # ====================
  # NOTE: stow を直接実行しないこと。-t ~ を付けないと親ディレクトリにリンクが作られる。
  # 必ず task link-* / task unlink-* を使用する。
  link:
    desc: 全パッケージをリンク
    cmds:
      - task: link-shell
      - task: link-config
      - task: link-claude
      - task: link-codex
      - task: link-tmux
      - task: link-alfred

  link-shell:
    desc: シェル設定をリンク (.zshrc, .zprofile)
    cmds:
      - stow {{.STOW_FLAGS}} shell

  link-config:
    desc: .config 配下をリンク (wezterm, starship, mise, sheldon)
    cmds:
      - stow {{.STOW_FLAGS}} config

  link-claude:
    desc: Claude CLI をリンク
    cmds:
      - stow {{.STOW_FLAGS}} claude

  link-codex:
    desc: Codex CLI をリンク
    cmds:
      - stow {{.STOW_FLAGS}} codex

  link-tmux:
    desc: tmux 設定をリンク (.tmux.conf)
    cmds:
      - stow {{.STOW_FLAGS}} tmux

  link-alfred:
    desc: Alfred ワークフローをリンク
    cmds:
      - |
        src="{{.ROOT_DIR}}/alfred/Open-VS-or-IT"
        dest="$HOME/Dropbox/02_Private/08_Settings/02_Alfred/Alfred.alfredpreferences/workflows/user.workflow.C9692AD7-2800-42B7-8F97-8F8CCD1CC88E"
        if [[ -L "$dest" ]]; then
          echo "Already linked: $dest"
        elif [[ -e "$dest" ]]; then
          echo "Warning: $dest exists and is not a symlink. Skipping."
        else
          ln -snf "$src" "$dest"
          echo "Linked: $dest -> $src"
        fi

  # ====================
  # リンク解除
  # ====================
  unlink:
    desc: 全パッケージのリンクを解除
    cmds:
      - task: unlink-shell
      - task: unlink-config
      - task: unlink-claude
      - task: unlink-codex
      - task: unlink-tmux
      - task: unlink-alfred

  unlink-shell:
    desc: シェル設定のリンクを解除
    cmds:
      - stow -D {{.STOW_FLAGS}} shell

  unlink-config:
    desc: .config 配下のリンクを解除
    cmds:
      - stow -D {{.STOW_FLAGS}} config

  unlink-claude:
    desc: Claude CLI のリンクを解除
    cmds:
      - stow -D {{.STOW_FLAGS}} claude

  unlink-codex:
    desc: Codex CLI のリンクを解除
    cmds:
      - stow -D {{.STOW_FLAGS}} codex

  unlink-tmux:
    desc: tmux 設定のリンクを解除
    cmds:
      - stow -D {{.STOW_FLAGS}} tmux

  unlink-alfred:
    desc: Alfred ワークフローのリンクを解除
    cmds:
      - |
        dest="$HOME/Dropbox/02_Private/08_Settings/02_Alfred/Alfred.alfredpreferences/workflows/user.workflow.C9692AD7-2800-42B7-8F97-8F8CCD1CC88E"
        if [[ -L "$dest" ]]; then
          rm "$dest"
          echo "Unlinked: $dest"
        else
          echo "Not a symlink or not found: $dest"
        fi

  # ====================
  # 再リンク (restow)
  # ====================
  restow:
    desc: 全パッケージを再リンク（削除してから作成）
    cmds:
      - stow -R {{.STOW_FLAGS}} shell config claude codex tmux
      - task: unlink-alfred
      - task: link-alfred

  restow-shell:
    desc: シェル設定を再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} shell

  restow-config:
    desc: .config 配下を再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} config

  restow-claude:
    desc: Claude CLI を再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} claude

  restow-codex:
    desc: Codex CLI を再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} codex

  restow-tmux:
    desc: tmux 設定を再リンク
    cmds:
      - stow -R {{.STOW_FLAGS}} tmux

  restow-alfred:
    desc: Alfred ワークフローを再リンク
    cmds:
      - task: unlink-alfred
      - task: link-alfred
