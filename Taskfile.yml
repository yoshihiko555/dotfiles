# Taskfile.yml
# Êó•Â∏∏ÁöÑ„Å™„Çø„Çπ„ÇØÁÆ°ÁêÜÁî®„ÄÇÂàùÂõû„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó„ÅØ Makefile (make bootstrap) „Çí‰ΩøÁî®„ÄÇ
version: "3"

vars:
  STOW_FLAGS: -v -t ~

tasks:
  # ====================
  # „Éá„Éï„Ç©„É´„Éà & „Éò„É´„Éó
  # ====================
  default:
    desc: Âà©Áî®ÂèØËÉΩ„Å™„Çø„Çπ„ÇØ‰∏ÄË¶ß„ÇíË°®Á§∫
    cmds:
      - task --list

  # ====================
  # „É™„É≥„ÇØÁÆ°ÁêÜ
  # ====================
  link:
    desc: ÂÖ®„Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„É™„É≥„ÇØ
    cmds:
      - task: link-shell
      - task: link-config
      - task: link-claude
      - task: link-codex

  link-shell:
    desc: „Ç∑„Çß„É´Ë®≠ÂÆö„Çí„É™„É≥„ÇØ (.zshrc, .zprofile)
    cmds:
      - stow {{.STOW_FLAGS}} shell

  link-config:
    desc: .config ÈÖç‰∏ã„Çí„É™„É≥„ÇØ (wezterm, starship, mise, sheldon)
    cmds:
      - stow {{.STOW_FLAGS}} config

  link-claude:
    desc: Claude CLI „Çí„É™„É≥„ÇØ
    cmds:
      - stow {{.STOW_FLAGS}} claude

  link-codex:
    desc: Codex CLI „Çí„É™„É≥„ÇØ
    cmds:
      - stow {{.STOW_FLAGS}} codex

  # ====================
  # „É™„É≥„ÇØËß£Èô§
  # ====================
  unlink:
    desc: ÂÖ®„Éë„ÉÉ„Ç±„Éº„Ç∏„ÅÆ„É™„É≥„ÇØ„ÇíËß£Èô§
    cmds:
      - task: unlink-shell
      - task: unlink-config
      - task: unlink-claude
      - task: unlink-codex

  unlink-shell:
    desc: „Ç∑„Çß„É´Ë®≠ÂÆö„ÅÆ„É™„É≥„ÇØ„ÇíËß£Èô§
    cmds:
      - stow -D {{.STOW_FLAGS}} shell

  unlink-config:
    desc: .config ÈÖç‰∏ã„ÅÆ„É™„É≥„ÇØ„ÇíËß£Èô§
    cmds:
      - stow -D {{.STOW_FLAGS}} config

  unlink-claude:
    desc: Claude CLI „ÅÆ„É™„É≥„ÇØ„ÇíËß£Èô§
    cmds:
      - stow -D {{.STOW_FLAGS}} claude

  unlink-codex:
    desc: Codex CLI „ÅÆ„É™„É≥„ÇØ„ÇíËß£Èô§
    cmds:
      - stow -D {{.STOW_FLAGS}} codex

  # ====================
  # ÂÜç„É™„É≥„ÇØ (restow)
  # ====================
  restow:
    desc: ÂÖ®„Éë„ÉÉ„Ç±„Éº„Ç∏„ÇíÂÜç„É™„É≥„ÇØÔºàÂâäÈô§„Åó„Å¶„Åã„Çâ‰ΩúÊàêÔºâ
    cmds:
      - stow -R {{.STOW_FLAGS}} shell config claude codex

  restow-shell:
    desc: „Ç∑„Çß„É´Ë®≠ÂÆö„ÇíÂÜç„É™„É≥„ÇØ
    cmds:
      - stow -R {{.STOW_FLAGS}} shell

  restow-config:
    desc: .config ÈÖç‰∏ã„ÇíÂÜç„É™„É≥„ÇØ
    cmds:
      - stow -R {{.STOW_FLAGS}} config

  restow-claude:
    desc: Claude CLI „ÇíÂÜç„É™„É≥„ÇØ
    cmds:
      - stow -R {{.STOW_FLAGS}} claude

  restow-codex:
    desc: Codex CLI „ÇíÂÜç„É™„É≥„ÇØ
    cmds:
      - stow -R {{.STOW_FLAGS}} codex

  # ====================
  # Skills ÂêåÊúü
  # ====================
  sync-skills:
    desc: shared/skills „Çí„ÇÇ„Å®„Å´ Codex/Claude „ÅÆ„Çπ„Ç≠„É´„É™„É≥„ÇØ„ÇíÊõ¥Êñ∞
    cmds:
      - |
        set -eu
        root="{{.ROOT_DIR}}"
        common="$root/shared/skills/common"
        codex_only="$root/shared/skills/codex-only"
        claude_only="$root/shared/skills/claude-only"
        codex_target="$root/codex/.codex/skills"
        claude_target="$root/claude/.claude/skills"

        mkdir -p "$codex_target" "$claude_target"

        cleanup_links() {
          target_dir="$1"
          rel_prefix="$2"
          if [ -d "$target_dir" ]; then
            find "$target_dir" -maxdepth 1 -type l -print | while read -r link; do
              link_target="$(readlink "$link")"
              case "$link_target" in
                "$rel_prefix"/*) rm -f "$link" ;;
              esac
            done
          fi
        }

        link_dir() {
          src_dir="$1"
          target_dir="$2"
          rel_prefix="$3"
          if [ -d "$src_dir" ]; then
            find "$src_dir" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) -print | while read -r path; do
              name="$(basename "$path")"
              ln -snf "$rel_prefix/$name" "$target_dir/$name"
            done
          fi
        }

        cleanup_links "$codex_target" "../../../shared/skills/common"
        cleanup_links "$codex_target" "../../../shared/skills/codex-only"
        cleanup_links "$claude_target" "../../../shared/skills/common"
        cleanup_links "$claude_target" "../../../shared/skills/claude-only"

        link_dir "$common" "$codex_target" "../../../shared/skills/common"
        link_dir "$common" "$claude_target" "../../../shared/skills/common"
        link_dir "$codex_only" "$codex_target" "../../../shared/skills/codex-only"
        link_dir "$claude_only" "$claude_target" "../../../shared/skills/claude-only"

  # ====================
  # „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£
  # ====================
  status:
    desc: ÁèæÂú®„ÅÆ„Ç∑„É≥„Éú„É™„ÉÉ„ÇØ„É™„É≥„ÇØÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
    cmds:
      - |
        echo "üìÅ Shell:"
        ls -la ~/.zshrc ~/.zprofile 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "üìÅ Config:"
        ls -la ~/.config/wezterm ~/.config/starship ~/.config/mise ~/.config/sheldon 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "üìÅ Claude:"
        ls -la ~/.claude 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "üìÅ Codex:"
        ls -la ~/.codex 2>/dev/null || echo "  (not linked)"

  brew:
    desc: Homebrew „Éë„ÉÉ„Ç±„Éº„Ç∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´
    cmds:
      - bash {{.ROOT_DIR}}/scripts/install-brew.sh
      - brew bundle --file={{.ROOT_DIR}}/Brewfile

  edit:
    desc: dotfiles „Çí VS Code „ÅßÈñã„Åè
    cmds:
      - code ~/.dotfiles
