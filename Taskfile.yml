# Taskfile.yml
# æ—¥å¸¸çš„ãªã‚¿ã‚¹ã‚¯ç®¡ç†ç”¨ã€‚åˆå›ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã¯ Makefile (make bootstrap) ã‚’ä½¿ç”¨ã€‚
version: "3"

vars:
  STOW_FLAGS: -v -t ~

tasks:
  # ====================
  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ & ãƒ˜ãƒ«ãƒ—
  # ====================
  default:
    desc: åˆ©ç”¨å¯èƒ½ãªã‚¿ã‚¹ã‚¯ä¸€è¦§ã‚’è¡¨ç¤º
    cmds:
      - task --list

  # ====================
  # ãƒªãƒ³ã‚¯ç®¡ç†
  # ====================
  link:
    desc: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ãƒªãƒ³ã‚¯
    cmds:
      - task: link-shell
      - task: link-config
      - task: link-claude
      - task: link-codex

  link-shell:
    desc: ã‚·ã‚§ãƒ«è¨­å®šã‚’ãƒªãƒ³ã‚¯ (.zshrc, .zprofile)
    cmds:
      - stow {{.STOW_FLAGS}} shell

  link-config:
    desc: .config é…ä¸‹ã‚’ãƒªãƒ³ã‚¯ (wezterm, starship, mise, sheldon)
    cmds:
      - stow {{.STOW_FLAGS}} config

  link-claude:
    desc: Claude CLI ã‚’ãƒªãƒ³ã‚¯
    cmds:
      - stow {{.STOW_FLAGS}} claude

  link-codex:
    desc: Codex CLI ã‚’ãƒªãƒ³ã‚¯
    cmds:
      - stow {{.STOW_FLAGS}} codex

  # ====================
  # ãƒªãƒ³ã‚¯è§£é™¤
  # ====================
  unlink:
    desc: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤
    cmds:
      - task: unlink-shell
      - task: unlink-config
      - task: unlink-claude
      - task: unlink-codex

  unlink-shell:
    desc: ã‚·ã‚§ãƒ«è¨­å®šã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤
    cmds:
      - stow -D {{.STOW_FLAGS}} shell

  unlink-config:
    desc: .config é…ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤
    cmds:
      - stow -D {{.STOW_FLAGS}} config

  unlink-claude:
    desc: Claude CLI ã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤
    cmds:
      - stow -D {{.STOW_FLAGS}} claude

  unlink-codex:
    desc: Codex CLI ã®ãƒªãƒ³ã‚¯ã‚’è§£é™¤
    cmds:
      - stow -D {{.STOW_FLAGS}} codex

  # ====================
  # å†ãƒªãƒ³ã‚¯ (restow)
  # ====================
  restow:
    desc: å…¨ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å†ãƒªãƒ³ã‚¯ï¼ˆå‰Šé™¤ã—ã¦ã‹ã‚‰ä½œæˆï¼‰
    cmds:
      - stow -R {{.STOW_FLAGS}} shell config claude codex

  restow-shell:
    desc: ã‚·ã‚§ãƒ«è¨­å®šã‚’å†ãƒªãƒ³ã‚¯
    cmds:
      - stow -R {{.STOW_FLAGS}} shell

  restow-config:
    desc: .config é…ä¸‹ã‚’å†ãƒªãƒ³ã‚¯
    cmds:
      - stow -R {{.STOW_FLAGS}} config

  restow-claude:
    desc: Claude CLI ã‚’å†ãƒªãƒ³ã‚¯
    cmds:
      - stow -R {{.STOW_FLAGS}} claude

  restow-codex:
    desc: Codex CLI ã‚’å†ãƒªãƒ³ã‚¯
    cmds:
      - stow -R {{.STOW_FLAGS}} codex

  # ====================
  # Skills åŒæœŸ
  # ====================
  sync-skills:
    desc: shared/skills ã‚’ã‚‚ã¨ã« Codex/Claude ã®ã‚¹ã‚­ãƒ«ãƒªãƒ³ã‚¯ã‚’æ›´æ–°
    cmds:
      - |
        set -eu
        root="{{.ROOT_DIR}}"
        common="$root/shared/skills/common"
        codex_only="$root/shared/skills/codex-only"
        claude_only="$root/shared/skills/claude-only"
        codex_target="$root/codex/.codex/skills"
        claude_target="$root/claude/.claude/skills"

        mkdir -p "$codex_target" "$claude_target"

        cleanup_links() {
          target_dir="$1"
          rel_prefix="$2"
          if [ -d "$target_dir" ]; then
            find "$target_dir" -maxdepth 1 -type l -print | while read -r link; do
              link_target="$(readlink "$link")"
              case "$link_target" in
                "$rel_prefix"/*) rm -f "$link" ;;
              esac
            done
          fi
        }

        link_dir() {
          src_dir="$1"
          target_dir="$2"
          rel_prefix="$3"
          if [ -d "$src_dir" ]; then
            find "$src_dir" -mindepth 1 -maxdepth 1 \( -type d -o -type l \) -print | while read -r path; do
              name="$(basename "$path")"
              ln -snf "$rel_prefix/$name" "$target_dir/$name"
            done
          fi
        }

        cleanup_links "$codex_target" "../../../shared/skills/common"
        cleanup_links "$codex_target" "../../../shared/skills/codex-only"
        cleanup_links "$claude_target" "../../../shared/skills/common"
        cleanup_links "$claude_target" "../../../shared/skills/claude-only"

        link_dir "$common" "$codex_target" "../../../shared/skills/common"
        link_dir "$common" "$claude_target" "../../../shared/skills/common"
        link_dir "$codex_only" "$codex_target" "../../../shared/skills/codex-only"
        link_dir "$claude_only" "$claude_target" "../../../shared/skills/claude-only"

  # ====================
  # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
  # ====================
  status:
    desc: ç¾åœ¨ã®ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯çŠ¶æ…‹ã‚’ç¢ºèª
    cmds:
      - |
        echo "ğŸ“ Shell:"
        ls -la ~/.zshrc ~/.zprofile 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "ğŸ“ Config:"
        ls -la ~/.config/wezterm ~/.config/starship ~/.config/mise ~/.config/sheldon 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "ğŸ“ Claude:"
        ls -la ~/.claude 2>/dev/null || echo "  (not linked)"
        echo ""
        echo "ğŸ“ Codex:"
        ls -la ~/.codex 2>/dev/null || echo "  (not linked)"

  brew:
    desc: Homebrew ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    cmds:
      - bash {{.ROOT_DIR}}/scripts/install-brew.sh
      - brew bundle --file={{.ROOT_DIR}}/Brewfile

  edit:
    desc: dotfiles ã‚’ VS Code ã§é–‹ã
    cmds:
      - code {{.ROOT_DIR}}

  mcp-init:
    desc: ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã« .mcp.json ã‚’ã‚³ãƒ”ãƒ¼
    cmds:
      - |
        if [ -f .mcp.json ]; then
          echo "âš ï¸  .mcp.json already exists. Use 'task mcp-show' to view template."
        else
          cp {{.ROOT_DIR}}/shared/mcp.template.json .mcp.json
          echo "âœ… .mcp.json created. Edit as needed."
        fi

  mcp-show:
    desc: MCP ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å†…å®¹ã‚’è¡¨ç¤º
    cmds:
      - cat {{.ROOT_DIR}}/shared/mcp.template.json
